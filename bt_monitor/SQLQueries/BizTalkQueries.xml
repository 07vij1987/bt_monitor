<ConfigurationValues>
<!--Suspension Monitor-->
  <SUSPENDEDINSTANCE>
    DECLARE @msgBoxTables TABLE(rowNumber INT IDENTITY(1,1),msgBoxName varchar(30))
    DECLARE @temptbl TABLE( ServiceName NVARCHAR(1000),ServiceID UNIQUEIDENTIFIER,ServiceClass NVARCHAR(256), InstanceCount INT, Host nVarchar(256))
    DECLARE @messageBoxName varchar(30), @totalRows INT ,@QueryString nvarchar(max)
    BEGIN
    INSERT INTO @msgBoxTables(msgBoxName)
    SELECT [NAME] FROM sys.databases WHERE [Name] LIKE 'BizTalkMsgBoxDb%'

    SET @totalRows = (SELECT COUNT(*) FROM @msgBoxTables)
    WHILE @totalRows > 0
    BEGIN
    SET @messageBoxName = (SELECT msgBoxName FROM @msgBoxTables WHERE rowNumber = @totalRows )

    SET @QueryString ='SELECT ISNULL(ISNULL(item.FULLNAME,rp.nvcName),sp.nvcName) AS [Service Name],
    i.uidServiceID AS [Service ID],
    ISNULL(sc.nvcName,
    CASE
    WHEN i.nvcErrorID=''0xC0C01B4e'' THEN ''Routing Failure Report''
    END
    ) AS [Service Class] ,
    COUNT(*) AS [Instance Count],
    app.nvcApplicationName AS [Host]
    FROM [' + @messageBoxName + '].dbo.[Instances] i
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[Services] s ON i.uidServiceID = s.uidServiceID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[Modules] m ON m.nModuleID = s.nModuleID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[ServiceClasses] sc ON sc.uidServiceClassID = i.UIDClassID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_item item ON item.GUID = i.uidServiceID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_receiveport rp ON  rp.uidGUID= i.uidServiceID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_sendport sp ON sp.uidGUID = i.uidServiceID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[applications] app ON app.uidAppID =i.uidAppOwnerID
    WHERE m.nvcName  IS NOT NULL {0}
    AND i.nState IN (4,32)
    GROUP BY ISNULL(ISNULL(item.FULLNAME,rp.nvcName),sp.nvcName),i.uidServiceID ,ISNULL(sc.nvcName,
    CASE
    WHEN i.nvcErrorID=''0xC0C01B4e'' THEN ''Routing Failure Report''
    END
    ), app.nvcApplicationName'

    INSERT INTO @temptbl([ServiceName],[ServiceID],[ServiceClass],[InstanceCount],[Host])
    EXEC sp_executesql @QueryString
    SET @totalRows =@totalRows-1
    END
    SELECT ServiceName AS [Service Name],ServiceID AS [Service ID],ServiceClass AS [Service Class],SUM(InstanceCount) AS [Instance Count], Host AS [Host] FROM @temptbl
    GROUP BY ServiceName,ServiceID,ServiceClass,Host
    ORDER BY SUM(InstanceCount) DESC
    END
  </SUSPENDEDINSTANCE>
  <INSTANCEDETAILFROMSERVICEID>
    DECLARE @msgBoxTables TABLE(rowNumber INT IDENTITY(1,1),msgBoxName varchar(30))
    DECLARE @instanceDetalTbl TABLE([Instance ID] UNIQUEIDENTIFIER,[Error Code] VARCHAR(512),[Status] VARCHAR(256),[Suspend Time] DATETIME,[Creation Time] DATETIME,[Processing Server] VARCHAR(256),[Error Description] VARCHAR(max))
    DECLARE @messageBoxName varchar(30), @totalRows int, @row bit,@serviceClass NVARCHAR(256)
    DECLARE @rowExists TABLE([rowPresent] bit)
    DECLARE @QueryString nvarchar(max)
    DECLARE @QueryString2 nvarchar(max)
    BEGIN
    SET @serviceClass ='{1}'
    INSERT INTO @msgBoxTables(msgBoxName)
    SELECT [NAME] FROM sys.databases WHERE [Name] LIKE 'BizTalkMsgBoxDb%'
    SET @totalRows = (SELECT COUNT(*) FROM @msgBoxTables)
    WHILE @totalRows > 0
    BEGIN

    SET @QueryString =''
    SET @QueryString2 =''
    SET @row=0
    DELETE FROM @rowExists

    SET @messageBoxName = (SELECT msgBoxName FROM @msgBoxTables WHERE rowNumber = @totalRows )
    SET @QueryString2='SELECT 1 FROM [' + @messageBoxName + '].dbo.[instancessuspended] WITH(READPAST) where uidserviceid =''{0}'''

    INSERT INTO @rowExists([rowPresent])EXEC sp_executesql @QueryString2
    SET @row =(SELECT TOP 1 [rowPresent] FROM @rowExists)
    IF @row = 1
    BEGIN
    IF @serviceClass ='Routing Failure Report'
    BEGIN
    SET @QueryString = 'SELECT  uidinstanceId AS [Instance ID],nvcErrorID AS [Error Code], CASE nState
    WHEN 4 THEN ''Suspended Resumable''
    WHEN 32 THEN ''Suspended Non-Resumable''
    END
    AS [Status],dtSuspendTimeStamp AS [Suspend TimeStamp],dtCreated AS [Creation Time],nvcErrorProcessingServer AS [Processing Server],
    nvcErrorDescription AS [Error Description] FROM [' + @messageBoxName + '].dbo.[instancessuspended] i
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[ServiceClasses] sc ON sc.uidServiceClassID = i.UIDClassID
    where uidserviceid =''{0}''
    AND nvcErrorID =''0xC0C01B4e'''
    END
    ELSE
    BEGIN
    SET @QueryString = 'SELECT  uidinstanceId AS [Instance ID],nvcErrorID AS [Error Code], CASE nState
    WHEN 4 THEN ''Suspended Resumable''
    WHEN 32 THEN ''Suspended Non-Resumable''
    END
    AS [Status],dtSuspendTimeStamp AS [Suspend TimeStamp],dtCreated AS [Creation Time],nvcErrorProcessingServer AS [Processing Server],
    nvcErrorDescription AS [Error Description] FROM [' + @messageBoxName + '].dbo.[instancessuspended] i
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[ServiceClasses] sc ON sc.uidServiceClassID = i.UIDClassID
    where uidserviceid =''{0}''
    AND sc.nvcName =''{1}'''
    END

    INSERT INTO @instanceDetalTbl([Instance ID],[Error Code],[Status],[Suspend Time],[Creation Time],[Processing Server],[Error Description])
    EXEC sp_executesql @QueryString
    END
    SET @totalRows = @totalRows-1
    END
    DELETE FROM @rowExists
    SELECT [Instance ID],[Error Code],[Status],[Suspend Time],[Creation Time],[Processing Server],[Error Description] FROM @instanceDetalTbl ORDER BY [Suspend Time] DESC,[Creation Time] DESC
    END
  </INSTANCEDETAILFROMSERVICEID>
  <MESSAGETYPEFORSUSPENDEDINSTANCE>
    DECLARE @msgBoxTables TABLE(rowNumber INT IDENTITY(1,1),msgBoxName varchar(30))
    DECLARE @messageBoxName varchar(30), @totalRows int
    DECLARE @QueryString nvarchar(max)
    CREATE TABLE #msgIdTable(uidMessageId UNIQUEIDENTIFIER)
    BEGIN
    INSERT INTO @msgBoxTables(msgBoxName)
    SELECT [NAME] FROM sys.databases WHERE [Name] LIKE 'BizTalkMsgBoxDb%'
    SET @totalRows = (SELECT COUNT(*) FROM @msgBoxTables)
    WHILE @totalRows >0
    BEGIN
    SET @messageBoxName = (SELECT msgBoxName FROM @msgBoxTables WHERE rowNumber = @totalRows )

    SET @QueryString = 'IF EXISTS(SELECT 1 FROM [' + @messageBoxName + '].dbo.{0} WITH(READPAST) WHERE uidinstanceid IN ({1})
    UNION SELECT 1 FROM [' + @messageBoxName + '].dbo.{2} WITH(READPAST) WHERE uidinstanceid IN ({1}))
    BEGIN
    INSERT INTO #msgIdTable(uidMessageId)
    SELECT uidmessageid FROM [' + @messageBoxName + '].dbo.{0} WITH(READPAST) WHERE uidinstanceid IN ({1})
    UNION
    SELECT uidmessageid FROM [' + @messageBoxName + '].dbo.{2} WITH(READPAST) WHERE uidinstanceid IN ({1})

    SELECT ISNULL(nvcmessagetype,''NS#RootNode'')AS [MessageType],uidmessageid AS [MessageID]
    FROM [' + @messageBoxName + '].dbo.[SPOOL] WITH(READPAST) WHERE uidmessageid in (SELECT uidMessageId FROM #msgIdTable)
    END'

    EXEC sp_executesql @QueryString
    SET @totalRows = @totalRows-1
    END
    DROP TABLE #msgIdTable
    END
  </MESSAGETYPEFORSUSPENDEDINSTANCE>
  <READMESSAGEDATA>
    DECLARE @msgBoxTables TABLE(rowNumber INT IDENTITY(1,1),msgBoxName varchar(30))
    DECLARE @messageBoxName varchar(30), @totalRows int
    DECLARE @QueryString nvarchar(4000)
    BEGIN
    INSERT INTO @msgBoxTables(msgBoxName)
    SELECT [NAME] FROM sys.databases WHERE [Name] LIKE 'BizTalkMsgBoxDb%'
    SET @totalRows = (SELECT COUNT(*) FROM @msgBoxTables)
    WHILE @totalRows >0
    BEGIN
    SET @messageBoxName = (SELECT msgBoxName FROM @msgBoxTables WHERE rowNumber = @totalRows )
    SET @QueryString = 'IF EXISTS(SELECT 1 FROM [' + @messageBoxName + '].dbo.Parts WITH(READPAST)
    WHERE uidPartID in (SELECT uidPartID FROM [' + @messageBoxName+ '].dbo.MessageParts WITH(READPAST)
    WHERE uidMessageID IN (''{0}'')))
    BEGIN
    SELECT imgPart FROM [' + @messageBoxName + '].dbo.Parts WITH(READPAST)
    WHERE uidPartID in (SELECT uidPartID FROM [' + @messageBoxName+ '].dbo.MessageParts WITH(READPAST)
    WHERE uidMessageID IN (''{0}''))
    END
    '
    EXEC sp_executesql @QueryString
    SET @totalRows = @totalRows-1
    END
    END
  </READMESSAGEDATA>
<!--END-->
<!--Custom MsgBox Query-->
  <CustomQueryConditiondata>
    SELECT nvcName as [AppName] FROM BizTalkMgmtDb.dbo.bts_application {0} ORDER BY [AppName]
    SELECT NAME as [HostName] FROM dbo.adm_Host {1} ORDER BY [HostName]
  </CustomQueryConditiondata>
  <AllServiceInstance>
    DECLARE @msgBoxTables TABLE(rowNumber INT IDENTITY(1,1),msgBoxName varchar(30))
    DECLARE @tblGroupData TABLE(
    [Application Name] VARCHAR(256),
    [Service Name] VARCHAR(256),
    [Instance ID] UNIQUEIDENTIFIER,
    [Service Class] VARCHAR(100),
    [Status] VARCHAR(256),
    [Creation Time] DATETIME,
    [Processing Server] VARCHAR(256),
    [Host] VARCHAR(256),
    [Error Code] VARCHAR(512),
    [Error Description] VARCHAR(max),
    [Suspend Time] DATETIME)
    DECLARE @messageBoxName varchar(30), @totalRows int
    DECLARE @QueryString nvarchar(max)

    BEGIN
    INSERT INTO @msgBoxTables(msgBoxName)
    SELECT [NAME] FROM sys.databases WHERE [Name] LIKE 'BizTalkMsgBoxDb%'
    SET @totalRows = (SELECT COUNT(*) FROM @msgBoxTables)
    SET @QueryString =''

    WHILE @totalRows >0
    BEGIN
    SET @messageBoxName = (SELECT msgBoxName FROM @msgBoxTables WHERE rowNumber = @totalRows )

    SET @QueryString = 'SELECT TOP {0} m.nvcName AS [Application Name],
    ISNULL(ISNULL(item.FULLNAME,rp.nvcName),sp.nvcName) AS [Service Name],
    uidInstanceID AS [Instance ID],
    ISNULL(sc.nvcName,
    CASE
    WHEN i.nvcErrorID=''0xC0C01B4e'' THEN ''Routing Failure Report''
    END
    ) AS [Service Class],
    CASE nState
    WHEN 1 THEN ''Ready To Run''
    WHEN 2 THEN ''Active''
    WHEN 4 THEN ''Suspended Resumable''
    WHEN 8 THEN ''Dehydrated''
    WHEN 16 THEN ''Completed With Discarded Messages''
    WHEN 32 THEN ''Suspended Non-Resumable''
    END AS [Status],
    dtCreated AS [Creation Time],
    ISNULL(nvcProcessingServer,nvcErrorProcessingServer) AS [Processing Server],
    app.nvcApplicationName AS [Host],
    nvcErrorID AS [Error Code],
    nvcErrorDescription AS [Error Description],
    dtSuspendTimestamp as [Suspend Time]
    FROM [' + @messageBoxName + '].dbo.[Instances] i
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[Services] s ON i.uidServiceID = s.uidServiceID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[Modules] m ON m.nModuleID = s.nModuleID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[ServiceClasses] sc ON sc.uidServiceClassID = i.UIDClassID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_item item ON item.GUID = i.uidServiceID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_receiveport rp ON  rp.uidGUID= i.uidServiceID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_sendport sp ON sp.uidGUID = i.uidServiceID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[applications] app ON app.uidAppID =i.uidAppOwnerID
    WHERE m.nvcName IS NOT NULL {1} {2}'

    INSERT INTO @tblGroupData([Application Name],[Service Name],[Instance ID],[Service Class],[Status],[Creation Time],[Processing Server],
    [Host],[Error Code],[Error Description],[Suspend Time] )

    EXEC sp_executesql @QueryString

    SET @totalRows=@totalRows-1
    SET @QueryString =''
    END
    SELECT * FROM @tblGroupData ORDER BY [Creation Time] DESC
    END
  </AllServiceInstance>
  <CustomQuery>
    DECLARE @msgBoxTables TABLE(rowNumber INT IDENTITY(1,1),msgBoxName varchar(30))
    DECLARE @tblGroupData TABLE(
    [Application Name] VARCHAR(256),
    [Service Name] VARCHAR(256),
    [Instance ID] UNIQUEIDENTIFIER,
    [Service Class] VARCHAR(100),
    [Status] VARCHAR(256),
    [Creation Time] DATETIME,
    [Processing Server] VARCHAR(256),
    [Host] VARCHAR(256),
    [Error Code] VARCHAR(512),
    [Error Description] VARCHAR(max),
    [Suspend Time] DATETIME)
    DECLARE @messageBoxName varchar(30), @totalRows int
    DECLARE @QueryString nvarchar(max)

    BEGIN
    INSERT INTO @msgBoxTables(msgBoxName)
    SELECT [NAME] FROM sys.databases WHERE [Name] LIKE 'BizTalkMsgBoxDb%'
    SET @totalRows = (SELECT COUNT(*) FROM @msgBoxTables)
    SET @QueryString =''

    WHILE @totalRows >0
    BEGIN
    SET @messageBoxName = (SELECT msgBoxName FROM @msgBoxTables WHERE rowNumber = @totalRows )

    SET @QueryString = 'SELECT TOP {0} m.nvcName AS [Application Name],
    ISNULL(ISNULL(item.FULLNAME,rp.nvcName),sp.nvcName) AS [Service Name],
    uidInstanceID AS [Instance ID],
    ISNULL(sc.nvcName,
    CASE
    WHEN i.nvcErrorID=''0xC0C01B4e'' THEN ''Routing Failure Report''
    END
    ) AS [Service Class],
    CASE nState
    WHEN 1 THEN ''Ready To Run''
    WHEN 2 THEN ''Active''
    WHEN 4 THEN ''Suspended Resumable''
    WHEN 8 THEN ''Dehydrated''
    WHEN 16 THEN ''Completed With Discarded Messages''
    WHEN 32 THEN ''Suspended Non-Resumable''
    END AS [Status],
    dtCreated AS [Creation Time],
    ISNULL(nvcProcessingServer,nvcErrorProcessingServer)  AS [Processing Server],
    app.nvcApplicationName AS [Host],
    nvcErrorID AS [Error Code],
    nvcErrorDescription AS [Error Description],
    dtSuspendTimestamp as [Suspend Time]
    FROM [' + @messageBoxName + '].dbo.[Instances] i
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[Services] s ON i.uidServiceID = s.uidServiceID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[Modules] m ON m.nModuleID = s.nModuleID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[ServiceClasses] sc ON sc.uidServiceClassID = i.UIDClassID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_item item ON item.GUID = i.uidServiceID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_receiveport rp ON  rp.uidGUID= i.uidServiceID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_sendport sp ON sp.uidGUID = i.uidServiceID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[applications] app ON app.uidAppID =i.uidAppOwnerID
    WHERE  m.nvcName IS NOT NULL {1} {2}'

    INSERT INTO @tblGroupData([Application Name],[Service Name],[Instance ID],[Service Class],[Status],[Creation Time],[Processing Server],
    [Host],[Error Code],[Error Description],[Suspend Time] )
    EXEC sp_executesql @QueryString

    SET @totalRows=@totalRows-1
    SET @QueryString =''
    END
    SELECT * FROM @tblGroupData ORDER BY [Creation Time] DESC
    END
  </CustomQuery>
  <CustomQueryGroup>
    DECLARE @msgBoxTables TABLE(rowNumber INT IDENTITY(1,1),msgBoxName varchar(30))
    DECLARE @messageBoxName varchar(30), @totalRows INT ,@QueryString nvarchar(max), @FinalSql nvarchar(max)
    BEGIN
    INSERT INTO @msgBoxTables(msgBoxName)
    SELECT [NAME] FROM sys.databases WHERE [Name] LIKE 'BizTalkMsgBoxDb%'

    SET @totalRows = (SELECT COUNT(*) FROM @msgBoxTables)
    SET @QueryString =''
    WHILE @totalRows > 0
    BEGIN
    SET @messageBoxName = (SELECT msgBoxName FROM @msgBoxTables WHERE rowNumber = @totalRows )

    SET @QueryString =@QueryString + 'SELECT {1}, COUNT(*) AS [InstanceCount]
    FROM [' + @messageBoxName + '].dbo.[Instances] i
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[Services] s ON i.uidServiceID = s.uidServiceID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[Modules] m ON m.nModuleID = s.nModuleID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[ServiceClasses] sc ON sc.uidServiceClassID = i.UIDClassID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_item item ON item.GUID = i.uidServiceID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_receiveport rp ON  rp.uidGUID= i.uidServiceID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_sendport sp ON sp.uidGUID = i.uidServiceID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[applications] app ON app.uidAppID =i.uidAppOwnerID
    WHERE m.nvcName  IS NOT NULL {0} {5} GROUP BY {2}'

    IF @totalRows >1
    BEGIN
    SET @QueryString = @QueryString + ' UNION ALL  '
    END

    SET @totalRows =@totalRows-1
    END
    SET @FinalSql = 'WITH TEMP AS (' + @QueryString + ') SELECT '''' AS [Instance ID], {4} ,SUM(InstanceCount) AS [InstanceCount] FROM TEMP GROUP BY {3}  ORDER BY SUM(InstanceCount) DESC'
    EXEC sp_executesql @FinalSql
    END
  </CustomQueryGroup>
  <ExpandQuery>
    DECLARE @msgBoxTables TABLE(rowNumber INT IDENTITY(1,1),msgBoxName varchar(30))
    DECLARE @tblGroupData TABLE(
    [Application Name] VARCHAR(256),
    [Service Name] VARCHAR(256),
    [Instance ID] UNIQUEIDENTIFIER,
    [Service Class] VARCHAR(100),
    [Status] VARCHAR(256),
    [Creation Time] DATETIME,
    [Processing Server] VARCHAR(256),
    [Host] VARCHAR(256),
    [Pending Job] VARCHAR(50),
    [Error Code] VARCHAR(512),
    [Error Description] VARCHAR(max),
    [Suspend Time] DATETIME)
    DECLARE @messageBoxName varchar(30), @totalRows int
    DECLARE @QueryString nvarchar(max)

    BEGIN
    INSERT INTO @msgBoxTables(msgBoxName)
    SELECT [NAME] FROM sys.databases WHERE [Name] LIKE 'BizTalkMsgBoxDb%'
    SET @totalRows = (SELECT COUNT(*) FROM @msgBoxTables)
    SET @QueryString =''

    WHILE @totalRows >0
    BEGIN
    SET @messageBoxName = (SELECT msgBoxName FROM @msgBoxTables WHERE rowNumber = @totalRows )

    SET @QueryString = 'SELECT TOP {1} m.nvcName AS [Application Name],
    ISNULL(ISNULL(item.FULLNAME,rp.nvcName),sp.nvcName) AS [Service Name],
    uidInstanceID AS [Instance ID],
    ISNULL(sc.nvcName,
    CASE
    WHEN i.nvcErrorID=''0xC0C01B4e'' THEN ''Routing Failure Report''
    END
    ) AS [Service Class],
    CASE nState
    WHEN 1 THEN ''Ready To Run''
    WHEN 2 THEN ''Active''
    WHEN 4 THEN ''Suspended Resumable''
    WHEN 8 THEN ''Dehydrated''
    WHEN 16 THEN ''Completed With Discarded Messages''
    WHEN 32 THEN ''Suspended Non-Resumable''
    END AS [Status],
    dtCreated AS [Creation Time],
    ISNULL(nvcProcessingServer,nvcErrorProcessingServer) AS [Processing Server],
    app.nvcApplicationName AS [Host],
    CASE(SELECT nPendingOperation FROM [' + @messageBoxName + '].dbo.[InstancesPendingOperations] WHERE uidInstanceID=i.uidInstanceID )
    WHEN 4 THEN ''Suspend''
    WHEN 8 THEN ''Terminate''
    ELSE ''None''
    END
    as [Pending Job],
    nvcErrorID AS [Error Code],
    nvcErrorDescription AS [Error Description],
    dtSuspendTimestamp as [Suspend Time]
    FROM [' + @messageBoxName + '].dbo.[Instances] i
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[Services] s ON i.uidServiceID = s.uidServiceID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[Modules] m ON m.nModuleID = s.nModuleID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[ServiceClasses] sc ON sc.uidServiceClassID = i.UIDClassID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_item item ON item.GUID = i.uidServiceID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_receiveport rp ON  rp.uidGUID= i.uidServiceID
    LEFT OUTER JOIN BizTalkMgmtDb.dbo.bts_sendport sp ON sp.uidGUID = i.uidServiceID
    LEFT OUTER JOIN [' + @messageBoxName + '].dbo.[applications] app ON app.uidAppID =i.uidAppOwnerID
    WHERE m.nvcName IS NOT NULL {2} {0}'

    INSERT INTO @tblGroupData([Application Name],[Service Name],[Instance ID],[Service Class],[Status],[Creation Time],[Processing Server],
    [Host],[Pending Job],[Error Code],[Error Description],[Suspend Time] )
    EXEC sp_executesql @QueryString

    SET @totalRows=@totalRows-1
    SET @QueryString =''
    END
    SELECT * FROM @tblGroupData
    END
  </ExpandQuery>
  <!--END-->
  <!--Artefacts-->
  <ReceivePIPELINEInfo>
    SELECT r.Name AS [Receive Location],p.Name, p.FullyQualifiedName, s.Name AS [Stage],c.Name AS [Component],ps.Sequence,s.ExecOptions, c.TypeName,r.ReceivePipelineData
    FROM
    bts_pipeline as p WITH(READPAST),
    bts_pipeline_config as ps WITH(READPAST),
    bts_pipeline_stage as s WITH(READPAST),
    bts_component as c WITH(READPAST),
    bts_stage_config as sc WITH(READPAST),
    adm_ReceiveLocation as r WITH(READPAST)
    WHERE
    ps.PipelineID = p.Id AND
    ps.PipelineID=r.ReceivePipelineID AND
    ps.StageID = s.Id AND
    sc.StageID = s.Id AND
    sc.CompID = c.Id AND
    r.ReceivePipelineID IN (SELECT TOP 1 ReceivePipelineID FROM dbo.adm_ReceiveLocation WITH(READPAST) WHERE [NAME]='{0}')
    AND r.Name ='{0}'
    ORDER BY ps.Sequence

    SELECT Name AS  [Pipeline Name], FullyQualifiedName FROM bts_pipeline WITH(READPAST)
    WHERE ID IN (SELECT  TOP 1 ReceivePipelineID FROM dbo.adm_ReceiveLocation WITH(READPAST) WHERE [NAME]='{0}')
  </ReceivePIPELINEInfo>
  <SendPIPELINEInfo>
    SELECT r.Name AS [Receive Location],p.Name, p.FullyQualifiedName, s.Name AS [Stage],c.Name AS [Component],ps.Sequence,s.ExecOptions, c.TypeName,r.SendPipelineData
    FROM
    bts_pipeline as p WITH(READPAST),
    bts_pipeline_config as ps WITH(READPAST),
    bts_pipeline_stage as s WITH(READPAST),
    bts_component as c WITH(READPAST),
    bts_stage_config as sc WITH(READPAST),
    adm_ReceiveLocation as r WITH(READPAST)
    WHERE
    ps.PipelineID = p.Id AND
    ps.PipelineID=r.SendPipelineID AND
    ps.StageID = s.Id AND
    sc.StageID = s.Id AND
    sc.CompID = c.Id AND
    r.SendPipelineID IN (SELECT TOP 1 SendPipelineID FROM dbo.adm_ReceiveLocation WITH(READPAST) WHERE [NAME]='{0}')
    AND r.Name ='{0}'
    ORDER BY ps.Sequence

    SELECT Name AS  [Pipeline Name], FullyQualifiedName FROM bts_pipeline WITH(READPAST)
    WHERE ID IN (SELECT  TOP 1 SendPipelineID FROM dbo.adm_ReceiveLocation WITH(READPAST) WHERE [NAME]='{0}')
  </SendPIPELINEInfo>
  <SendPortInfo>
    SELECT
    bOrderedDelivery AS [Ordered Delivery],
    CAST(nDeliveryNotification as BIT) AS [Delivery Notification],
    nRetryCount AS [Retry Count],
    sp.nPriority AS [Priority],
    nRetryInterval AS [Retry Interval],
    bIsServiceWindow AS [Service Window],
    CONVERT(varchar, dtFromTime, 8) AS [Window Start Time],
    CONVERT(varchar, dtToTime, 8) AS [Window End Time],
    sp.bRouteFailedmessage AS [Failed Routing]
    FROM dbo.bts_sendport_transport spt
    JOIN dbo.bts_sendport sp
    ON spt.nSendPortID = sp.nID
    WHERE sp.nvcName ='{0}'
    AND bIsPrimary =1

    SELECT
    st.nvcAddress AS [URI],
    st.nTransportTypeId as [Transport Type],
    h.[Name]  as [Send Handler],
    st.nRetryCount AS [Retry Count],
    st.nRetryInterval AS [Retry Interval],
    st.bIsServiceWindow AS [Service Window],
    CONVERT(varchar, st.dtFromTime, 8) AS [Window Start Time],
    CONVERT(varchar, st.dtToTime, 8) AS [Window End Time]
    FROM dbo.bts_sendport_transport st
    JOIN dbo.bts_sendport sp
    ON st.nSendPortID = sp.nID
    LEFT JOIN dbo.adm_SendHandler sh
    ON sh.ID =st.nSendHandlerID
    LEFT JOIN dbo.adm_Host h
    on h.ID =sh.HostId
    WHERE sp.nvcName ='{0}'
    AND st.bIsPrimary =0

    SELECT p.Name, p.FullyQualifiedName, s.Name AS [Stage],c.Name AS [Component],
    ps.Sequence,s.ExecOptions, c.TypeName,sp.nvcSendPipelineData
    FROM
    bts_pipeline as p,
    bts_pipeline_config as ps,
    bts_pipeline_stage as s ,
    bts_component as c ,
    bts_stage_config as sc ,
    dbo.bts_sendport as sp
    WHERE
    ps.PipelineID = p.Id AND
    ps.PipelineID=sp.nSendPipelineID AND
    ps.StageID = s.Id AND
    sc.StageID = s.Id AND
    sc.CompID = c.Id
    AND sp.nvcName ='{0}'
    ORDER BY ps.Sequence

    SELECT Name AS  [Pipeline Name], FullyQualifiedName
    FROM bts_pipeline p
    JOIN dbo.bts_sendport s
    ON p.ID =s.nSendPipelineID
    WHERE s.[nvcNAME]='{0}'

    SELECT p.Name, p.FullyQualifiedName, s.Name AS [Stage],c.Name AS [Component],
    ps.Sequence,s.ExecOptions, c.TypeName,sp.nvcReceivePipelineData
    FROM
    bts_pipeline as p,
    bts_pipeline_config as ps,
    bts_pipeline_stage as s,
    bts_component as c,
    bts_stage_config as sc,
    dbo.bts_sendport as sp
    WHERE
    ps.PipelineID = p.Id AND
    ps.PipelineID=sp.nReceivePipelineID AND
    ps.StageID = s.Id AND
    sc.StageID = s.Id AND
    sc.CompID = c.Id AND
    sp.[nvcNAME]='{0}'
    ORDER BY ps.Sequence

    SELECT Name AS  [Pipeline Name],
    FullyQualifiedName FROM
    bts_pipeline  p
    JOIN dbo.bts_sendport s
    ON p.ID =s.nReceivePipelineID
    WHERE s.[nvcNAME]='{0}'

    SELECT  nvcFilter  FROM dbo.bts_sendport WITH(READPAST) WHERE [nvcNAME]= '{0}'
  </SendPortInfo>
  <HOSTINFO>
    SELECT NAME as 'Host Name', NTGroupName as 'Group',
    CASE HostType
    WHEN 1 Then 'In-Process'
    WHEN 2 Then 'Isolated'
    END AS 'Host Type',
    CAST(CASE HostTracking WHEN 1 THEN 1 WHEN 0 THEN 0 WHEN -1 THEN 1 END AS BIT) as 'Tracking',
    CAST(CASE AuthTrusted WHEN 1 THEN 1 ELSE 0 END AS BIT) as 'Trusted',
    IsHost32BitOnly as '32 Bit Host'
    FROM dbo.adm_Host WITH(READPAST)
    ORDER BY 'Host Name'
  </HOSTINFO>
  <HOSTINFOSHARED>
    SELECT NAME as 'Host Name', NTGroupName as 'Group',
    CASE HostType
    WHEN 1 Then 'In-Process'
    WHEN 2 Then 'Isolated'
    END AS 'Host Type',
    CAST(CASE HostTracking WHEN 1 THEN 1 WHEN 0 THEN 0 WHEN -1 THEN 1 END AS BIT) as 'Tracking',
    CAST(CASE AuthTrusted WHEN 1 THEN 1 ELSE 0 END AS BIT) as 'Trusted',
    IsHost32BitOnly as '32 Bit Host'
    FROM dbo.adm_Host WITH(READPAST)
    WHERE Name LIKE '%{0}%'
    ORDER BY 'Host Name'
  </HOSTINFOSHARED>
  <APPINFO>
    CREATE TABLE #msgBoxTables(rowNumber INT IDENTITY(1,1),msgBoxName varchar(30))
    DECLARE @messageBoxName varchar(30), @totalRows int
    DECLARE @QueryString nvarchar(max)
    DECLARE @FinalQuery nvarchar(max)
    DECLARE @AppStatus NVARCHAR(MAX)
    BEGIN
    INSERT INTO #msgBoxTables(msgBoxName)
    SELECT [NAME] FROM sys.databases WHERE [Name] LIKE 'BizTalkMsgBoxDb%'
    SET @totalRows = (SELECT COUNT(*) FROM #msgBoxTables)
    SET @QueryString =''
    SET @AppStatus ='((SELECT COUNT(*) FROM [BizTalkMgmtDb].dbo.adm_ReceiveLocation r
    WHERE ReceivePortId IN ( SELECT nID FROM [BizTalkMgmtDb].dbo.bts_receiveport
    WHERE  nApplicationID = (SELECT nID FROM [BizTalkMgmtDb].dbo.bts_application WHERE nvcname =i.nvcName))
    AND [Disabled] =-1) +
    (SELECT COUNT(*) FROM [BizTalkMgmtDb].dbo.bts_sendport s
    WHERE  nApplicationID = (SELECT nID FROM [BizTalkMgmtDb].dbo.bts_application WHERE nvcname =i.nvcName)
    AND [nPortStatus] =2) +
    (SELECT COUNT(*) FROM [BizTalkMgmtDb].[dbo].[bts_orchestration] AS ORCH
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_assembly AS Asse
    ON ORCH.nAssemblyID = Asse.nID
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_application AS APP
    ON Asse.nApplicationID = APP.nID
    WHERE  APP.nID = (SELECT nID FROM [BizTalkMgmtDb].dbo.bts_application WHERE nvcname =i.nvcName)
    AND ORCH.[nOrchestrationStatus] IN (1,2)))'
    WHILE @totalRows >0
    BEGIN
    SET @messageBoxName = (SELECT msgBoxName FROM #msgBoxTables WHERE rowNumber = @totalRows )

    IF(@totalRows=1)
    BEGIN
    SET @QueryString =@QueryString + '(SELECT COUNT(*) FROM [' + @messageBoxName + '].dbo.[InstancesSuspended] WITH(READPAST) WHERE uidserviceid IN
    (SELECT uidServiceID FROM [' + @messageBoxName + '].dbo.[Services] WITH(READPAST) WHERE nModuleID =
    (SELECT nModuleID FROM [' + @messageBoxName + '].dbo.[Modules] WITH(READPAST) WHERE nvcname =i.nvcName)))'
    END
    ELSE
    BEGIN
    SET @QueryString =@QueryString + '(SELECT COUNT(*) FROM [' + @messageBoxName + '].dbo.[InstancesSuspended] WITH(READPAST) WHERE uidserviceid IN
    (SELECT uidServiceID FROM [' + @messageBoxName + '].dbo.[Services] WHERE nModuleID =
    (SELECT nModuleID FROM [' + @messageBoxName + '].dbo.[Modules] WHERE nvcname =i.nvcName)))' + ' + '
    END
    SET @totalRows=@totalRows-1
    END
    DROP TABLE #msgBoxTables
    SET @FinalQuery ='SELECT nvcName as [AppName],' + @AppStatus + ' AS [Status], ((' + @QueryString + ' )) AS [SuspensionCount]FROM BizTalkMgmtDb.dbo.bts_application i'
    EXEC sp_executesql @FinalQuery
    END
  </APPINFO>
  <APPINFOSHARED>
    CREATE TABLE #msgBoxTables(rowNumber INT IDENTITY(1,1),msgBoxName varchar(30))
    DECLARE @messageBoxName varchar(30), @totalRows int
    DECLARE @QueryString nvarchar(max)
    DECLARE @FinalQuery nvarchar(max)
    DECLARE @AppStatus NVARCHAR(MAX)
    BEGIN
    INSERT INTO #msgBoxTables(msgBoxName)
    SELECT [NAME] FROM sys.databases WHERE [Name] LIKE 'BizTalkMsgBoxDb%'
    SET @totalRows = (SELECT COUNT(*) FROM #msgBoxTables)
    SET @QueryString =''
    SET @AppStatus ='((SELECT COUNT(*) FROM [BizTalkMgmtDb].dbo.adm_ReceiveLocation r
    WHERE ReceivePortId IN ( SELECT nID FROM [BizTalkMgmtDb].dbo.bts_receiveport
    WHERE  nApplicationID = (SELECT nID FROM [BizTalkMgmtDb].dbo.bts_application WHERE nvcname =i.nvcName))
    AND [Disabled] =-1) +
    (SELECT COUNT(*) FROM [BizTalkMgmtDb].dbo.bts_sendport s
    WHERE  nApplicationID = (SELECT nID FROM [BizTalkMgmtDb].dbo.bts_application WHERE nvcname =i.nvcName)
    AND [nPortStatus] =2) +
    (SELECT COUNT(*) FROM [BizTalkMgmtDb].[dbo].[bts_orchestration] AS ORCH
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_assembly AS Asse
    ON ORCH.nAssemblyID = Asse.nID
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_application AS APP
    ON Asse.nApplicationID = APP.nID
    WHERE  APP.nID = (SELECT nID FROM [BizTalkMgmtDb].dbo.bts_application WHERE nvcname =i.nvcName)
    AND ORCH.[nOrchestrationStatus] IN (1,2)))'
    WHILE @totalRows >0
    BEGIN
    SET @messageBoxName = (SELECT msgBoxName FROM #msgBoxTables WHERE rowNumber = @totalRows )

    IF(@totalRows=1)
    BEGIN
    SET @QueryString =@QueryString + '(SELECT COUNT(*) FROM [' + @messageBoxName + '].dbo.[InstancesSuspended] WITH(READPAST) WHERE uidserviceid IN
    (SELECT uidServiceID FROM [' + @messageBoxName + '].dbo.[Services] WITH(READPAST) WHERE nModuleID =
    (SELECT nModuleID FROM [' + @messageBoxName + '].dbo.[Modules] WITH(READPAST) WHERE nvcname =i.nvcName)))'
    END
    ELSE
    BEGIN
    SET @QueryString =@QueryString + '(SELECT COUNT(*) FROM [' + @messageBoxName + '].dbo.[InstancesSuspended] WITH(READPAST) WHERE uidserviceid IN
    (SELECT uidServiceID FROM [' + @messageBoxName + '].dbo.[Services] WHERE nModuleID =
    (SELECT nModuleID FROM [' + @messageBoxName + '].dbo.[Modules] WHERE nvcname =i.nvcName)))' + ' + '
    END
    SET @totalRows=@totalRows-1
    END
    DROP TABLE #msgBoxTables
    SET @FinalQuery ='SELECT nvcName as [AppName],' + @AppStatus + ' AS [Status], ((' + @QueryString + ' )) AS [SuspensionCount]FROM BizTalkMgmtDb.dbo.bts_application i WHERE nvcName LIKE ''%{0}%'''
    EXEC sp_executesql @FinalQuery
    END
  </APPINFOSHARED>
  <APPReceivePort>
    SELECT rp.nvcName as [Port Name],
    bTwoWay as [Is Two Way],
    bRouteFailedMessage as [Route Failed Message]
    FROM dbo.bts_receiveport rp
    JOIN dbo.bts_application APP
    ON rp.nApplicationID =APP.nID
    WHERE  APP.nvcname ='{0}'
  </APPReceivePort>
  <AppReceiveLocation>
    SELECT
    r.[Name] as [Location Name],
    CASE Disabled
    WHEN -1 THEN 'Disabled'
    WHEN 0 THEN 'Enabled'
    END as [Status],
    adp.[Name]  as [Transport],
    CASE OperatingWindowEnabled
    WHEN 1 THEN 'Enabled'
    WHEN 0 THEN 'Disabled'
    END as [Service Window],
    CASE OperatingWindowEnabled
    WHEN 1 THEN
    (CONVERT(varchar, SrvWinStartDT, 8) + ' - ' + CONVERT(varchar, SrvWinStopDT, 8))
    ELSE 'NA'
    END	AS [Service Window Time],
    InboundTransportURL as [URI],
    rp.nvcName as [Port Name],
    h.[Name] as [Receive Handler]
    FROM dbo.adm_ReceiveLocation r
    JOIN dbo.bts_receiveport rp
    ON r.ReceivePortId=rp.nID
    JOIN dbo.adm_ReceiveHandler RH
    ON r.ReceiveHandlerId =RH.Id
    JOIN dbo.adm_Host h
    ON h.ID =RH.HostId
    JOIN dbo.bts_application APP
    ON APP.nID =rp.nApplicationID
    JOIN dbo.adm_Adapter adp
    ON adp.ID = r.AdapterId
    WHERE APP.nvcname ='{0}'
    ORDER BY [Transport]
  </AppReceiveLocation>
  <AppSendPorts>
    SELECT s.nvcName as [Port Name],
    CASE nPortStatus
    WHEN 3 THEN 'Started'
    WHEN 2 THEN 'Stopped'
    END  as [Status],
    spt.nvcAddress  AS [URI],
    adp.[Name] AS [Transport Type],
    h.[Name] AS [Send Handler]
    FROM dbo.bts_sendport s
    JOIN dbo.bts_application APP
    ON s.nApplicationID = APP.nID
    JOIN dbo.bts_sendport_transport spt
    ON s.nID = spt.nSendPortID
    JOIN dbo.adm_Adapter adp
    ON adp.ID =spt.nTransportTypeId
    JOIN dbo.adm_SendHandler sh
    ON sh.ID =spt.nSendHandlerID
    JOIN dbo.adm_Host h
    on h.ID =sh.HostId
    WHERE  APP.nvcname ='{0}'
  </AppSendPorts>
  <AppOrchestrations>
    SELECT ORCH.nvcFullName AS OrchestrationName
    , CASE
    WHEN ORCH.[nOrchestrationStatus] = 3
    THEN 'Started'
    WHEN ORCH.[nOrchestrationStatus] = 2
    THEN 'Stopped'
    WHEN ORCH.[nOrchestrationStatus] = 1
    THEN 'Unenlisted'
    ELSE 'Unknown status'
    END AS STATUS
    , Host.Name AS HostInstance
    , Asse.nvcFullName AS Assembly
    , ORCH.nvcDescription AS Description
    FROM [BizTalkMgmtDb].[dbo].[bts_orchestration] AS ORCH
    LEFT JOIN [BizTalkMgmtDb].[dbo].adm_Host AS Host
    ON ORCH.nAdminHostID = Host.ID
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_assembly AS Asse
    ON ORCH.nAssemblyID = Asse.nID
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_application AS APP
    ON Asse.nApplicationID = APP.nID
    WHERE  APP.nvcname ='{0}'
  </AppOrchestrations>
  <AllOrchestrations>
    SELECT ORCH.nvcFullName AS OrchestrationName
    , CASE
    WHEN ORCH.[nOrchestrationStatus] = 3
    THEN 'Started'
    WHEN ORCH.[nOrchestrationStatus] = 2
    THEN 'Stopped'
    WHEN ORCH.[nOrchestrationStatus] = 1
    THEN 'Unenlisted'
    ELSE 'Unknown status'
    END AS STATUS
    , Host.Name AS HostInstance
    , Asse.nvcFullName AS Assembly
    , APP.nvcName AS Application
    , ORCH.dtModified AS LastModified
    , ORCH.nvcDescription AS Description
    FROM [BizTalkMgmtDb].[dbo].[bts_orchestration] AS ORCH
    LEFT JOIN [BizTalkMgmtDb].[dbo].adm_Host AS Host
    ON ORCH.nAdminHostID = Host.ID
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_assembly AS Asse
    ON ORCH.nAssemblyID = Asse.nID
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_application AS APP
    ON Asse.nApplicationID = APP.nID
    ORDER BY Application
  </AllOrchestrations>
  <ReceiveLocationsShared>
    DECLARE @QueryString NVARCHAR(max)
    DECLARE @FilterStatus NVARCHAR(256), @FilterTransport NVARCHAR(256),@FilterApp NVARCHAR(256), @FilterPort NVARCHAR(256), @FilterHost NVARCHAR(80)
    BEGIN

    SET @FilterStatus ='{1}'
    SET @FilterTransport ='{2}'
    SET @FilterApp ='{3}'
    SET @FilterPort ='{4}'
    SET @FilterHost ='{5}'

    SET @QueryString ='SELECT
    r.[Name] as [LocationName],
    CASE r.Disabled
    WHEN -1 THEN ''Disabled''
    WHEN 0 THEN ''Enabled''
    END as [Status],
    adp.[Name]  as [Transport],
    CASE OperatingWindowEnabled
    WHEN 1 THEN ''owYES''
    WHEN 0 THEN ''owNO''
    END as [ServiceWindow],
    CONVERT(varchar, SrvWinStartDT, 8) AS [ServiceWindowStartTime],
    CONVERT(varchar, SrvWinStopDT, 8) AS [ServiceWindowEndTime],
    InboundTransportURL as [URI],
    APP.nvcName AS  [ApplicationName],
    rp.nvcName AS [PortName],
    h.[Name] AS [ReceiveHandler]
    FROM dbo.adm_ReceiveLocation r
    JOIN dbo.bts_receiveport rp
    ON r.ReceivePortId=rp.nID
    JOIN dbo.adm_ReceiveHandler RH
    ON r.ReceiveHandlerId =RH.Id
    JOIN dbo.adm_Host h
    ON h.ID =RH.HostId
    JOIN dbo.bts_application APP
    ON APP.nID =rp.nApplicationID
    JOIN dbo.adm_Adapter adp
    ON adp.ID = r.AdapterId {0}'

    IF (@FilterStatus = 'Disabled')
    BEGIN
    SET @QueryString = @QueryString+ ' AND r.Disabled = -1'
    END
    ELSE IF (@FilterStatus = 'Enabled')
    BEGIN
    SET @QueryString = @QueryString+ ' AND r.Disabled = 0'
    END

    IF @FilterTransport != 'ALL'
    BEGIN
    SET @QueryString = @QueryString+ ' AND adp.[Name] =''' + @FilterTransport + ''''
    END

    IF @FilterApp != 'ALL'
    BEGIN
    SET @QueryString = @QueryString+ ' AND APP.nvcName = ''' + @FilterApp + ''''
    END

    IF @FilterPort != 'ALL'
    BEGIN
    SET @QueryString = @QueryString+ ' AND rp.nvcName = ''' + @FilterPort + ''''
    END

    IF @FilterHost != 'ALL'
    BEGIN
    SET @QueryString = @QueryString+ ' AND h.[Name]  =''' + @FilterHost + ''''
    END

    EXEC sp_executesql @QueryString
    END
  </ReceiveLocationsShared>
  <SENDPORTSSHARED>
    DECLARE @QueryString NVARCHAR(max)
    DECLARE @FilterStatus NVARCHAR(256), @FilterTransport NVARCHAR(256),@FilterApp NVARCHAR(256), @FilterHost NVARCHAR(80)
    BEGIN

    SET @FilterStatus ='{1}'
    SET @FilterTransport ='{2}'
    SET @FilterApp ='{3}'
    SET @FilterHost ='{4}'

    SET @QueryString ='SELECT s.nvcName as [PortName],
    CASE nPortStatus
    WHEN 3 THEN ''  Started''
    WHEN 2 THEN ''Stopped''
    WHEN 1 THEN ''Unenlisted''
    END  as [Status],
    spt.nvcAddress  AS [URI],
    adp.[Name] AS [TransportType],
    h.[Name] AS [SendHandler],
    APP.nvcName AS [ApplicationName]
    FROM dbo.bts_sendport s
    JOIN BizTalkMgmtDb.dbo.bts_application APP
    ON s.nApplicationID = APP.nID
    JOIN BizTalkMgmtDb.dbo.bts_sendport_transport spt
    ON s.nID = spt.nSendPortID
    JOIN BizTalkMgmtDb.dbo.adm_Adapter adp
    ON adp.ID =spt.nTransportTypeId
    JOIN BizTalkMgmtDb.dbo.adm_SendHandler sh
    ON sh.ID =spt.nSendHandlerID
    JOIN BizTalkMgmtDb.dbo.adm_Host h
    on h.ID =sh.HostId
    WHERE  spt.nTransportTypeId IS NOT NULL {0}'

    IF (@FilterStatus = 'Started')
    BEGIN
    SET @QueryString = @QueryString+ ' AND s.nPortStatus = 3'
    END
    ELSE IF (@FilterStatus = 'Stopped')
    BEGIN
    SET @QueryString = @QueryString+ ' AND s.nPortStatus = 2'
    END
    ELSE IF (@FilterStatus = 'Unenlisted')
    BEGIN
    SET @QueryString = @QueryString+ ' AND s.nPortStatus = 1'
    END

    IF @FilterTransport != 'ALL'
    BEGIN
    SET @QueryString = @QueryString+ ' AND adp.[Name] =''' + @FilterTransport + ''''
    END

    IF @FilterApp != 'ALL'
    BEGIN
    SET @QueryString = @QueryString+ ' AND APP.nvcName = ''' + @FilterApp + ''''
    END

    IF @FilterHost != 'ALL'
    BEGIN
    SET @QueryString = @QueryString+ ' AND h.[Name]  =''' + @FilterHost + ''''
    END

    EXEC sp_executesql @QueryString
    END

  </SENDPORTSSHARED>
  <SearchArtefactConditionData>
    SELECT nvcName as [AppName] FROM BizTalkMgmtDb.dbo.bts_application WHERE nvcName LIKE '%{0}%' ORDER BY [AppName]
    SELECT NAME as [HostName] FROM BizTalkMgmtDb.dbo.adm_Host WHERE Name LIKE '%{1}%' ORDER BY [HostName]
    SELECT [NAME] as [TransportType] FROM dbo.adm_Adapter ORDER BY [TransportType]
    SELECT DISTINCT (indoc_docspec_name) AS [SourceSchema]  FROM [BizTalkMgmtDb].dbo.bt_MapSpec
    WHERE assemblyID IN (SELECT nID FROM [BizTalkMgmtDb].dbo.bts_assembly WHERE nvcName LIKE '%{0}%' )
    ORDER BY  [SourceSchema]
    SELECT DISTINCT (outdoc_docspec_name) AS [TargetSchema]  FROM [BizTalkMgmtDb].dbo.bt_MapSpec  WHERE assemblyID IN (SELECT nID FROM [BizTalkMgmtDb].dbo.bts_assembly WHERE nvcName LIKE '%{0}%' )
    ORDER BY  [TargetSchema]
  </SearchArtefactConditionData>
  <SearchArtefactODX>
    SELECT TOP {0} ORCH.nvcFullName AS [Artefact Name]
    , CASE
    WHEN ORCH.[nOrchestrationStatus] = 3
    THEN 'Started'
    WHEN ORCH.[nOrchestrationStatus] = 2
    THEN 'Stopped'
    WHEN ORCH.[nOrchestrationStatus] = 1
    THEN 'Unenlisted'
    ELSE 'Unknown status'
    END AS [Status]
    , HostInstance.Name AS [HostInstance],
    APP.nvcName AS [Application Name]
    FROM [BizTalkMgmtDb].[dbo].[bts_orchestration] AS ORCH
    LEFT JOIN [BizTalkMgmtDb].[dbo].adm_Host AS HostInstance
    ON ORCH.nAdminHostID = HostInstance.ID
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_assembly AS Asse
    ON ORCH.nAssemblyID = Asse.nID
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_application AS APP
    ON Asse.nApplicationID = APP.nID
    WHERE  APP.nvcname LIKE '%{1}%'
    {2} {3} ORDER BY [Artefact Name] ASC
  </SearchArtefactODX>
  <SearchArtefactAPP>
    CREATE TABLE #BTmsgBoxTables(rowNumber INT IDENTITY(1,1),msgBoxName varchar(30))
    DECLARE @messageBoxName varchar(30), @totalRows int
    DECLARE @QueryString nvarchar(max),@QryStrS nvarchar(max)
    DECLARE @FinalQuery nvarchar(max)
    BEGIN
    INSERT INTO #BTmsgBoxTables(msgBoxName)
    SELECT [NAME] FROM sys.databases WHERE [Name] LIKE 'BizTalkMsgBoxDb%'
    SET @totalRows = (SELECT COUNT(*) FROM #BTmsgBoxTables)
    SET @QueryString =''
    WHILE @totalRows >0
    BEGIN
    SET @messageBoxName = (SELECT msgBoxName FROM #BTmsgBoxTables WHERE rowNumber = @totalRows )

    IF(@totalRows=1)
    BEGIN
    SET @QueryString =@QueryString + '(SELECT COUNT(*) FROM [' + @messageBoxName + '].dbo.[InstancesSuspended] WITH(READPAST) WHERE uidserviceid IN
    (SELECT uidServiceID FROM [' + @messageBoxName + '].dbo.[Services] WITH(READPAST) WHERE nModuleID =
    (SELECT nModuleID FROM [' + @messageBoxName + '].dbo.[Modules] WITH(READPAST) WHERE nvcname =i.nvcName)))'
    END
    ELSE
    BEGIN
    SET @QueryString =@QueryString + '(SELECT COUNT(*) FROM [' + @messageBoxName + '].dbo.[InstancesSuspended] WITH(READPAST) WHERE uidserviceid IN
    (SELECT uidServiceID FROM [' + @messageBoxName + '].dbo.[Services] WHERE nModuleID =
    (SELECT nModuleID FROM [' + @messageBoxName + '].dbo.[Modules] WHERE nvcname =i.nvcName)))' + ' + '
    END
    SET @totalRows=@totalRows-1
    END

    DROP TABLE #BTmsgBoxTables

    SET @FinalQuery ='SELECT TOP {0} nvcName as [Artefact Name],
    (SELECT COUNT(*) FROM [BizTalkMgmtDb].dbo.adm_ReceiveLocation r
    WHERE ReceivePortId IN ( SELECT nID FROM [BizTalkMgmtDb].dbo.bts_receiveport
    WHERE  nApplicationID = (SELECT nID FROM [BizTalkMgmtDb].dbo.bts_application WHERE nvcname =i.nvcName))
    AND [Disabled] =-1) AS [ReceiveLocation],
    (SELECT COUNT(*) FROM [BizTalkMgmtDb].dbo.bts_sendport s
    WHERE  nApplicationID = (SELECT nID FROM [BizTalkMgmtDb].dbo.bts_application WHERE nvcname =i.nvcName)
    AND [nPortStatus] =2) AS [SendPort],
    (SELECT COUNT(*) FROM [BizTalkMgmtDb].[dbo].[bts_orchestration] AS ORCH
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_assembly AS Asse
    ON ORCH.nAssemblyID = Asse.nID
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_application AS APP
    ON Asse.nApplicationID = APP.nID
    WHERE  APP.nID = (SELECT nID FROM [BizTalkMgmtDb].dbo.bts_application WHERE nvcname =i.nvcName)
    AND ORCH.[nOrchestrationStatus] IN (1,2)) AS [Orchestration], ''Started'' AS [Status],((' + @QueryString + ' )) AS [Suspension Count] FROM BizTalkMgmtDb.dbo.bts_application i WHERE nvcName LIKE ''%{1}%''   {2} ORDER BY [Artefact Name] ASC'

    --PRINT @FinalQuery
    EXEC sp_executesql @FinalQuery
    END
  </SearchArtefactAPP>
  <SearchArtefactBTP>
    SELECT TOP {0}  NAME AS [Artefact Name],
    CASE Category
    WHEN 1 THEN 'Receive'
    ELSE 'Send'
    END AS [Pipeline Type],
    APP.nvcName AS [Application Name]
    FROM dbo.bts_pipeline p
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_assembly AS Asse
    ON p.nAssemblyID = Asse.nID
    JOIN [BizTalkMgmtDb].[dbo].bts_application AS APP
    ON Asse.nApplicationID = APP.nID
    WHERE  APP.nvcName LIKE '%{1}%'
    {2} {3} ORDER BY [Artefact Name] ASC
  </SearchArtefactBTP>
  <SearchArtefactRCVLOC>
    SELECT TOP {0}
    r.[Name] as [Artefact Name],
    CASE Disabled
    WHEN -1 THEN 'Disabled'
    WHEN 0 THEN 'Enabled'
    END as [Status],
    adp.[Name]  as [Transport],
    CASE OperatingWindowEnabled
    WHEN 1 THEN 'owYES'
    WHEN 0 THEN 'owNO'
    END as [Service Window],
    CONVERT(varchar, SrvWinStartDT, 8) AS [Service Window Start Time],
    CONVERT(varchar, SrvWinStopDT, 8) AS [Service Window End Time],
    InboundTransportURL as [URI],
    rp.nvcName AS [Port Name],
    h.[Name] AS [Receive Handler]
    FROM dbo.adm_ReceiveLocation r
    JOIN dbo.bts_receiveport rp
    ON r.ReceivePortId=rp.nID
    JOIN dbo.adm_ReceiveHandler RH
    ON r.ReceiveHandlerId =RH.Id
    JOIN dbo.adm_Host h
    ON h.ID =RH.HostId
    JOIN dbo.bts_application APP
    ON APP.nID =rp.nApplicationID
    JOIN dbo.adm_Adapter adp
    ON adp.ID = r.AdapterId
    WHERE APP.nvcName LIKE '%{1}%'
    {2} {3} ORDER BY [Artefact Name] ASC
  </SearchArtefactRCVLOC>
  <SearchArtefactRCVPORT>
    SELECT TOP {0} rp.nvcName as [Artefact Name],
    bTwoWay as [Is Two Way],
    bRouteFailedMessage as [Route Failed Message],
    APP.nvcname AS [Application Name]
    FROM dbo.bts_receiveport rp WITH(READPAST)
    JOIN BizTalkMgmtDb.dbo.bts_application APP
    ON rp.nApplicationID=APP.nID
    WHERE APP.nvcname  LIKE '%{1}%'
    {2} {3} ORDER BY [Artefact Name] ASC
  </SearchArtefactRCVPORT>
  <SearchArtefactXSD>
    SELECT TOP {0}
    item.FULLNAME AS [Artefact Name],
    schema_root_name AS [Root Name],
    CASE is_property_schema
    WHEN 1 THEN 'Property'
    ELSE 'Document'
    END AS [Schema Type],
    Is_MultiRoot,
    APP.nvcName AS [Application Name]
    FROM dbo.bt_DocumentSpec t
    JOIN [BizTalkMgmtDb].dbo.bts_item AS item
    ON t.itemID =item.id
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_assembly AS Asse
    ON t.AssemblyID = Asse.nID
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_application AS APP
    ON Asse.nApplicationID = APP.nID
    WHERE  APP.nvcName LIKE '%{1}%'
    {2} {3} ORDER BY [Artefact Name] ASC
  </SearchArtefactXSD>
  <SearchArtefactSNDPORT>
    SELECT TOP {0} s.nvcName as [Artefact Name],
    CASE nPortStatus
    WHEN 3 THEN 'Started'
    WHEN 2 THEN 'Stopped'
    WHEN 1 THEN 'Unenlisted'
    END  as [Status],
    spt.nvcAddress  AS [URI],
    adp.[Name] AS [Transport Type],
    h.[Name] AS [Send Handler],
    APP.nvcName AS [Application Name]
    FROM dbo.bts_sendport s
    JOIN BizTalkMgmtDb.dbo.bts_application APP
    ON s.nApplicationID = APP.nID
    JOIN BizTalkMgmtDb.dbo.bts_sendport_transport spt
    ON s.nID = spt.nSendPortID
    JOIN BizTalkMgmtDb.dbo.adm_Adapter adp
    ON adp.ID =spt.nTransportTypeId
    JOIN BizTalkMgmtDb.dbo.adm_SendHandler sh
    ON sh.ID =spt.nSendHandlerID
    JOIN BizTalkMgmtDb.dbo.adm_Host h
    on h.ID =sh.HostId
    WHERE spt.nTransportTypeId IS NOT NULL AND APP.nvcName LIKE '%{1}%'
    {2} {3} ORDER BY [Artefact Name] ASC
  </SearchArtefactSNDPORT>
  <SearchArtefactSNDPORTGRP>
    SELECT TOP {0} s.nvcName as [Artefact Name],
    CASE nPortStatus
    WHEN 3 THEN 'Started'
    WHEN 2 THEN 'Stopped'
    WHEN 1 THEN 'Unenlisted'
    END  as [Status],
    APP.nvcName AS [Application Name]
    FROM dbo.bts_sendportgroup s
    JOIN BizTalkMgmtDb.dbo.bts_application APP
    ON s.nApplicationID = APP.nID
    WHERE  APP.nvcName  LIKE '%{1}%'
    {2} {3} ORDER BY [Artefact Name] ASC
  </SearchArtefactSNDPORTGRP>
  <SearchArtefactBTM>
    SELECT TOP {0}
    i.FULLNAME AS [Artefact Name],
    indoc_docspec_name AS [Source Schema],
    outdoc_docspec_name AS [Target Schema],
    APP.nvcName AS [Application Name]
    FROM dbo.bt_MapSpec t
    JOIN [BizTalkMgmtDb].dbo.bts_item AS i
    ON t.itemID =i.id
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_assembly AS Asse
    ON t.AssemblyID = Asse.nID
    LEFT JOIN [BizTalkMgmtDb].[dbo].bts_application AS APP
    ON Asse.nApplicationID = APP.nID
    WHERE  APP.nvcName  LIKE '%{1}%'
    {2} {3} ORDER BY [Artefact Name] ASC
  </SearchArtefactBTM>
  <ReceiveLocationFiltersShared>
    SELECT 'Enabled' AS [Status]
    UNION
    SELECT 'Disabled' AS [Status]

    SELECT [NAME] FROM BizTalkMgmtDb.dbo.adm_Adapter ORDER BY [NAME]

    SELECT nvcName FROM BizTalkMgmtDb.dbo.bts_application {0} ORDER BY [nvcName]

    SELECT nvcName  FROM BizTalkMgmtDb.dbo.bts_receiveport WHERE  nApplicationID IN (SELECT nID FROM BizTalkMgmtDb.dbo.bts_application {0}) ORDER BY nvcName

    SELECT NAME FROM BizTalkMgmtDb.dbo.adm_Host WHERE  Id IN (SELECT HostId FROM BizTalkMgmtDb.dbo.adm_ReceiveHandler) {1} ORDER BY [NAME]
  </ReceiveLocationFiltersShared>
  <SendPortFiltersShared>
    SELECT 'Started' AS [Status]
    UNION
    SELECT 'Stopped' AS [Status]
    UNION
    SELECT 'Unenlisted' AS [Status]

    SELECT [NAME] FROM BizTalkMgmtDb.dbo.adm_Adapter ORDER BY [NAME]

    SELECT nvcName FROM BizTalkMgmtDb.dbo.bts_application {0} ORDER BY [nvcName]

    SELECT NAME FROM BizTalkMgmtDb.dbo.adm_Host WHERE Id IN (SELECT HostId FROM BizTalkMgmtDb.dbo.adm_SendHandler)  {1} ORDER BY [NAME]
  </SendPortFiltersShared>
  <!--END-->
</ConfigurationValues>
